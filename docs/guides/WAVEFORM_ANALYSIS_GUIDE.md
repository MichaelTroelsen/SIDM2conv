# Waveform Analysis Guide

Interactive HTML report generator for audio waveform comparison and validation.

**Version**: 0.7.2
**Last Updated**: 2025-12-12

---

## Overview

The Waveform Analysis tool generates interactive HTML reports that visualize and compare audio waveforms from SID→SF2 conversions. It provides visual validation of conversion quality by comparing original SID audio output (rendered by Laxity player) with exported SF2 audio output (rendered by SF2 player).

**Purpose**: Visual comparison of original vs converted audio to validate conversion quality

**Expected Result**: Differences are normal since different players are used (Laxity vs SF2)

---

## Quick Start

### Basic Usage

```bash
# Analyze all files in pipeline output
python scripts/analyze_waveforms.py output/SIDSF2player_Complete_Pipeline

# Analyze specific song directory
python scripts/analyze_waveforms.py output/MySong

# Analyze custom directory structure
python scripts/analyze_waveforms.py path/to/wav/files
```

### Requirements

**WAV Files Required**:
- Original SID rendered to WAV (e.g., `SongName_original.wav`)
- Exported SF2 rendered to WAV (e.g., `SongName_exported.wav`)

**Generated by Pipeline**:
- `complete_pipeline_with_validation.py` automatically creates these files
- Uses `SID2WAV.EXE` to render SID files to WAV format
- Typically 30-second renders at 16-bit quality

---

## Output Files

### Generated Reports

**Per Song**:
- `{SongName}_waveform_analysis.html` - Interactive HTML report

**Example**:
```
output/MySong/New/MySong_waveform_analysis.html
```

### Report Contents

Each HTML report includes:

1. **Embedded Audio Players**
   - Play original WAV file
   - Play exported WAV file
   - Side-by-side comparison

2. **HTML5 Canvas Waveform Visualizations**
   - Visual waveform display for original
   - Visual waveform display for exported
   - Overlaid comparison view
   - Interactive zoom and pan

3. **Similarity Metrics**
   - **Correlation**: Statistical correlation coefficient (-1 to 1)
   - **RMSE**: Root Mean Square Error (lower is better)
   - **Match Rate**: Percentage of matching samples

4. **File Statistics Comparison**
   - File sizes (bytes)
   - Sample rates (Hz)
   - Bit depths
   - Duration (seconds)
   - Channel count (mono/stereo)

5. **Analysis Notes**
   - Explanation of expected differences
   - Player differences (Laxity vs SF2)
   - Conversion accuracy context
   - Interpretation guidance

---

## Features

### Technical Features

**Python Standard Library Only**:
- Uses `wave` module for WAV parsing
- No NumPy or Matplotlib dependencies
- Pure Python implementation
- ~450 lines of code

**Self-Contained HTML**:
- Single HTML file per song
- No external CSS/JS dependencies
- Embedded audio data (base64)
- Portable and shareable

**Interactive Visualization**:
- HTML5 canvas-based rendering
- JavaScript waveform drawing
- Zoom and pan controls
- Sample-accurate display

### Analysis Capabilities

**Waveform Comparison**:
- Sample-by-sample visual comparison
- Amplitude difference highlighting
- Phase alignment detection
- Clipping and distortion detection

**Statistical Metrics**:
- Correlation coefficient (similarity measure)
- RMSE (error magnitude)
- Match rate (exact sample matches)
- Peak amplitude comparison

**File Validation**:
- Sample rate matching
- Bit depth verification
- Channel count consistency
- Duration comparison

---

## Use Cases

### 1. Conversion Quality Validation

**Scenario**: Verify that SID→SF2 conversion produces similar audio

**Workflow**:
```bash
# Run complete pipeline (generates WAV files)
python complete_pipeline_with_validation.py

# Generate waveform analysis
python scripts/analyze_waveforms.py output/SIDSF2player_Complete_Pipeline

# Open HTML reports in browser
# Look for high correlation (>0.8) and low RMSE (<0.1)
```

### 2. Player Behavior Analysis

**Scenario**: Understand differences between Laxity and SF2 players

**Workflow**:
1. Generate waveform reports
2. Compare sections where waveforms diverge
3. Identify player-specific behaviors (timing, filters, etc.)
4. Document player differences

### 3. Regression Testing

**Scenario**: Detect audio quality regressions after code changes

**Workflow**:
1. Generate baseline waveform reports (pre-change)
2. Make code changes
3. Regenerate waveform reports (post-change)
4. Compare metrics (correlation, RMSE) for regressions
5. Investigate any significant metric changes

### 4. Debug Conversion Issues

**Scenario**: Investigate why a conversion sounds wrong

**Workflow**:
1. Generate waveform report for problematic file
2. Visually identify problem areas (clipping, silence, noise)
3. Check similarity metrics for severity
4. Use findings to guide debugging efforts

---

## Interpreting Results

### Expected Differences

**Normal Variations** (Laxity vs SF2 players):
- **Filter implementation**: Different filter algorithms
- **Timing precision**: Slightly different frame timing
- **Wave table rendering**: Different interpolation
- **Envelope timing**: ADSR timing variations

**Correlation Guidelines**:
- `0.9 - 1.0`: Excellent similarity (very close)
- `0.8 - 0.9`: Good similarity (expected range)
- `0.7 - 0.8`: Moderate similarity (investigate)
- `< 0.7`: Poor similarity (likely conversion issue)

**RMSE Guidelines**:
- `< 0.05`: Excellent (very close match)
- `0.05 - 0.10`: Good (expected range)
- `0.10 - 0.20`: Moderate (investigate)
- `> 0.20`: Poor (likely conversion issue)

### Problem Indicators

**Red Flags**:
- Correlation < 0.7 (poor similarity)
- RMSE > 0.20 (high error)
- Large file size differences (>50% variation)
- Duration mismatches
- Complete silence in one file
- Excessive clipping

**Common Issues**:
- **Silence**: Conversion failed to initialize player
- **Noise**: Table data corruption
- **Clipping**: Excessive volume levels
- **Phase shift**: Timing alignment issue
- **Frequency shift**: Sample rate mismatch

---

## Technical Details

### Implementation

**Script**: `scripts/analyze_waveforms.py`
**Version**: 0.7.2
**Lines of Code**: ~450

**Dependencies**:
- Python 3.x
- `wave` module (standard library)
- `struct` module (standard library)
- `base64` module (standard library)
- `os`, `sys`, `pathlib` (standard library)

### WAV File Processing

**Supported Formats**:
- 16-bit PCM WAV (most common)
- 8-bit PCM WAV
- Mono and stereo

**Sample Processing**:
- Reads all samples into memory
- Normalizes to -1.0 to 1.0 range
- Calculates per-sample differences
- Computes aggregate statistics

### HTML Generation

**Template Structure**:
```html
<!DOCTYPE html>
<html>
<head>
  <style>/* Embedded CSS */</style>
</head>
<body>
  <h1>Waveform Analysis: {SongName}</h1>

  <!-- Audio Players -->
  <audio controls src="data:audio/wav;base64,..."></audio>

  <!-- Waveform Canvas -->
  <canvas id="waveform" width="1200" height="400"></canvas>

  <!-- Metrics Table -->
  <table>...</table>

  <!-- Analysis Notes -->
  <div class="notes">...</div>

  <script>/* Embedded JavaScript */</script>
</body>
</html>
```

**Canvas Rendering**:
- JavaScript draws waveforms using Canvas API
- Sample-accurate rendering
- Interactive zoom/pan controls
- Real-time metric updates

---

## Advanced Usage

### Custom Analysis Parameters

**Modify analyze_waveforms.py** for custom analysis:

```python
# Adjust sample window for visualization
SAMPLE_WINDOW = 10000  # Number of samples to display

# Adjust correlation window
CORRELATION_WINDOW = 1000  # Samples per correlation calculation

# Adjust RMSE normalization
RMSE_NORMALIZE = True  # Normalize RMSE to 0-1 range
```

### Batch Processing

```bash
# Process all songs in pipeline output
for dir in output/SIDSF2player_Complete_Pipeline/*/; do
    python scripts/analyze_waveforms.py "$dir"
done

# Or use find
find output/SIDSF2player_Complete_Pipeline -type d -name "New" -exec python scripts/analyze_waveforms.py {} \;
```

### Integration with Validation System

The waveform analysis tool integrates with the validation system:

```python
# In complete_pipeline_with_validation.py
# Step 7: Generate waveform analysis
subprocess.run([
    'python', 'scripts/analyze_waveforms.py',
    song_output_dir
])
```

---

## Troubleshooting

### Missing WAV Files

**Issue**: "WAV files not found"

**Solution**:
1. Ensure pipeline has run completely (Step 7: WAV generation)
2. Check that `SID2WAV.EXE` is in `tools/` directory
3. Verify WAV files exist in `output/{SongName}/New/`
4. Check file naming matches expected pattern

### Invalid WAV Format

**Issue**: "Cannot read WAV file"

**Solution**:
1. Ensure WAV files are valid PCM format
2. Check bit depth (8-bit or 16-bit)
3. Verify sample rate is standard (44100 Hz, 48000 Hz)
4. Re-generate WAV files using SID2WAV.EXE

### Low Correlation Scores

**Issue**: Correlation < 0.7 consistently

**Solution**:
1. Check if this is expected (Laxity vs SF2 player differences)
2. Verify conversion accuracy (use `validate_sid_accuracy.py`)
3. Compare frame dumps (siddump output)
4. Investigate table extraction issues
5. Check for player initialization problems

### Large File Size Differences

**Issue**: Original and exported WAV files differ significantly in size

**Solution**:
1. Check render duration settings (should be consistent)
2. Verify sample rate and bit depth match
3. Check for silence or premature termination
4. Ensure both WAV files rendered completely

---

## Related Documentation

- **Validation System**: `docs/guides/VALIDATION_GUIDE.md`
- **Pipeline Documentation**: `docs/ARCHITECTURE.md` (Section: Complete Pipeline)
- **Accuracy Validation**: `scripts/validate_sid_accuracy.py`
- **SID2WAV Tool**: `docs/TOOLS_REFERENCE.md`

---

## Future Enhancements

**Planned Features**:
- Spectrogram visualization
- Frequency domain analysis
- Harmonic distortion detection
- Automatic problem detection
- Comparative trend charts
- MIDI timing correlation

**Integration Goals**:
- Automated regression detection
- Dashboard integration
- CI/CD validation metrics
- Historical trend tracking

---

**Last Updated**: 2025-12-12
**Version**: 0.7.2
**Script**: `scripts/analyze_waveforms.py` (~450 lines)
