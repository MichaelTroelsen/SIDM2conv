name: CI/CD Pipeline

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  test:
    name: Run Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Display Python version
      run: python --version

    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov

    - name: Run unit tests with coverage
      run: |
        # Run Python unit tests if they exist
        if [ -d "pyscript" ]; then
          python -m pytest pyscript/test_*.py -v --cov=sidm2 --cov-report=xml --cov-report=term-missing || echo "No pytest tests found"
        fi
      continue-on-error: true

    - name: Upload coverage report
      if: matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage.xml

    - name: Run converter smoke test
      run: |
        python scripts/sid_to_sf2.py SID/Angular.sid test_output.sf2
        python -c "import os; assert os.path.exists('test_output.sf2'), 'Output file not created'"
      continue-on-error: true

    - name: Convert all SID files
      run: |
        mkdir -p SF2
        for sid in SID/*.sid; do
          if [ -f "$sid" ]; then
            basename="${sid##*/}"
            name="${basename%.sid}"
            echo "Converting $basename..."
            python scripts/sid_to_sf2.py "$sid" "SF2/${name}.sf2"
          fi
        done
      continue-on-error: true

    - name: Upload converted files
      uses: actions/upload-artifact@v4
      with:
        name: converted-sf2-files-${{ matrix.os }}-py${{ matrix.python-version }}
        path: SF2/*.sf2
        if-no-files-found: warn

  lint:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pylint

    - name: Run flake8
      run: |
        # Stop on syntax errors or undefined names
        flake8 scripts/ pyscript/ sidm2/ --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=__pycache__
        # Warnings for other issues
        flake8 scripts/ pyscript/ sidm2/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics --exclude=__pycache__
      continue-on-error: true

    - name: Run pylint
      run: |
        pylint --exit-zero --disable=C0114,C0115,C0116 scripts/*.py pyscript/*.py sidm2/*.py || echo "Pylint check completed with warnings"
      continue-on-error: true

  docs:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check README exists and has content
      run: |
        if [ ! -f README.md ]; then
          echo "ERROR: README.md not found"
          exit 1
        fi
        if [ ! -s README.md ]; then
          echo "ERROR: README.md is empty"
          exit 1
        fi
        echo "README.md exists and has content"

    - name: Check CONTRIBUTING exists
      run: |
        if [ ! -f CONTRIBUTING.md ]; then
          echo "ERROR: CONTRIBUTING.md not found"
          exit 1
        fi
        echo "CONTRIBUTING.md exists"

    - name: Check for required documentation sections
      run: |
        # Check README has key sections
        grep -q "## Usage" README.md || (echo "Missing Usage section" && exit 1)
        grep -q "## File Formats" README.md || (echo "Missing File Formats section" && exit 1)
        grep -q "## Development" README.md || (echo "Missing Development section" && exit 1)
        echo "All required documentation sections present"

    - name: Check Python docstrings
      run: |
        python -c "
        import ast
        import sys
        import os

        files = ['scripts/sid_to_sf2.py', 'sidm2/laxity_parser.py']
        errors = []

        for filename in files:
            if not os.path.exists(filename):
                continue
            with open(filename, 'r') as f:
                tree = ast.parse(f.read())

            for node in ast.walk(tree):
                if isinstance(node, (ast.FunctionDef, ast.ClassDef)):
                    if not ast.get_docstring(node):
                        errors.append(f'{filename}: {node.name} missing docstring')

        if errors:
            print('Missing docstrings:')
            for err in errors[:10]:  # Show first 10
                print(f'  - {err}')
            if len(errors) > 10:
                print(f'  ... and {len(errors) - 10} more')
            # Warning only, don't fail
            print('WARNING: Some functions missing docstrings')
        else:
            print('All functions have docstrings')
        "

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install bandit
      run: pip install bandit

    - name: Run security scan
      run: bandit -r . -ll -ii -x ./test_converter.py

  release:
    name: Create Release
    needs: [test, lint, docs]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get version
      id: version
      run: |
        VERSION=$(date +'%Y.%m.%d')-$(git rev-parse --short HEAD)
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Create archive
      run: |
        mkdir -p release
        cp -r scripts release/
        cp -r sidm2 release/
        cp -r pyscript release/
        cp -r drivers release/
        cp -r G5 release/
        cp README.md release/
        cp CHANGELOG.md release/
        cp CLAUDE.md release/
        cp CI_CD_SYSTEM.md release/ 2>/dev/null || true
        cp -r SID release/ 2>/dev/null || mkdir -p release/SID
        cp -r tools release/ 2>/dev/null || true
        cp *.bat release/ 2>/dev/null || true
        cd release && zip -r ../sidm2conv-${{ steps.version.outputs.version }}.zip .
      continue-on-error: true

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: sidm2conv-${{ steps.version.outputs.version }}
        path: sidm2conv-*.zip
      continue-on-error: true
